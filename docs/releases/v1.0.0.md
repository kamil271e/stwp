# Changelog:Â `feat/refactor`Â vsÂ `main`

## Summary

This is aÂ **major refactoring effort**Â that transforms STWP from a loosely organized collection of scripts into a proper Python package with modern tooling, CI/CD, comprehensive test coverage, and improved code quality. The changes affect ~13,700 lines added and ~6,500 lines removed across 123 files.

---

## ğŸ—ï¸ Architecture & Project Structure

### Package Reorganization (BREAKING)

- **Migrated toÂ `src/stwp/`Â layout**: All production code moved from scattered top-level directories (`models/`,Â `utils/`,Â `api/model/`) into a unifiedÂ `src/stwp/`Â package
    - `models/`Â â†’Â `src/stwp/models/`Â (GNN, CNN, linear, boosting, smoothing, TIGGE)
    - `utils/`Â â†’Â `src/stwp/utils/`Â (encoding, progress, visualization)
    - `api/model/`Â â†’Â `src/stwp/api/`Â (routes, services, schemas)
    - NewÂ `src/stwp/data/`Â module for data loading/processing
- **Import paths changed**: All imports now useÂ `from stwp.module import ...`Â instead of relative imports

### New Centralized Modules

- **[features.py](../../src/stwp/features.py)**: Eliminates magic strings (`'t2m'`,Â `'sp'`, etc.) with aÂ `Features`Â class providing type-safe constants, metadata (units, descriptions), and validation
- **[config.py](../../src/stwp/config.py)**: Unified configuration via dataclass with environment variable support (`STWP_*`Â prefix)
- **[constants.py](../../src/stwp/constants.py)**: Shared constants across the codebase

---

## ğŸ”§ Build & Tooling

### Modern Python Packaging

- **Migrated fromÂ `requirements.txt`Â toÂ `pyproject.toml`**: Proper Python packaging with hatch build backend
- **AdoptedÂ `uv`**Â as package manager: Faster dependency resolution with lockfile support ([uv.lock](../../uv.lock))
- **Added Makefile**Â with developer-friendly targets:Â `make install`,Â `make test`,Â `make format`,Â `make check`, etc.
- **Python 3.11 requirement**: Upgraded from 3.10 to 3.11

### Code Quality Tools

- **Replaced Black with Ruff**: Faster linting and formatting in one tool
- **Updated pre-commit hooks**Â ([.pre-commit-config.yaml](../../.pre-commit-config.yaml)):
    - Ruff for linting/formatting (replaces Black)
    - mypy for type checking onÂ `src/stwp/`
    - Security checks (detect-private-key, check-merge-conflict)
- **mypy configuration**: Type checking enabled forÂ `src/stwp/`Â with strict optional typing

---

## âœ… Testing

### New Test Suite (~1,740 lines)

- **Unit tests**Â ([tests/unit/](../../tests/unit/)): Configuration, data processor, encoding, features, visualization
- **API tests**Â ([tests/api/](../../tests/api/)): Endpoint testing with FastAPI TestClient, schema validation
- **HPO tests**Â ([tests/unit/test_hpo.py](../../tests/unit/test_hpo.py)): Comprehensive hyperparameter optimization testing (345 lines)
- **Experiment tests**Â ([tests/unit/test_experiments.py](../../tests/unit/test_experiments.py)): Analyzer class coverage (237 lines)
- **Shared fixtures**Â ([tests/conftest.py](../../tests/conftest.py)): Mock data, sample datasets, test configuration

### Test Configuration

- pytest with coverage reporting (`--cov=src/stwp`)
- pytest-asyncio for async API tests
- HTML coverage reports inÂ `htmlcov/`

---

## ğŸš€ CI/CD

### GitHub Actions Pipeline ([.github/workflows/ci.yml](../../.github/workflows/ci.yml))

- **Lint job**: Ruff check and format verification
- **Typecheck job**: mypy onÂ `src/stwp/`
- **Test job**: pytest with verbose output
- **Docker job**: Build verification on main branch (depends on all quality checks passing)

---

## ğŸ³ Docker & Deployment

### Improved Docker Setup

- **Upgraded to Python 3.11-slim**Â base image
- **UsesÂ `uv`Â in container**Â for faster builds (copied fromÂ `ghcr.io/astral-sh/uv:latest`)
- **Non-root user**Â (`app:1000`) for security
- **docker-compose.yml**Â added with health checks, timezone config, and restart policy
- **CDS API credentials**: Now supports runtime mounting or environment variables (not baked into image)

### API Restructuring

- **Modular routes**: Separated intoÂ `routes/weather.py`Â andÂ `routes/maps.py`
- **Service layer**: Business logic inÂ `services/prediction.py`Â andÂ `services/map_generator.py`
- **Pydantic schemas**: Request/response validation inÂ `schemas.py`
- **Entry point**:Â `stwp-api`Â CLI command via pyproject.toml scripts

---

## ğŸ“Š Code Quality Improvements

### Experiments & HPO Refactoring

- **[exp/experiments.py](../../exp/experiments.py)**: Complete rewrite with type hints, docstrings, logging, and pathlib usage
- **[hpo/hpo.py](../../hpo/hpo.py)**: Major refactor (~1,724 lines changed) with improved structure
- **Renamed**:Â `hpo/visualisation.py`Â â†’Â `hpo/visualization.py`Â (American spelling consistency)
- **Removed**Â `hpo/visualisation.py`Â (868 lines of duplicate code)

### Type Hints

- Added type annotations throughoutÂ `src/stwp/`
- numpy typing withÂ `NDArray[np.floating[Any]]`
- mypy strict optional checking enabled

### Notebooks Updated

- All demo notebooks ([demos/](../../demos/)) updated to use new import paths
- HPO analysis notebooks updated for renamed visualization module

---

## âš™ï¸ Configuration Changes

### Environment Variables (NEW)

All configuration now supports environment variable overrides withÂ `STWP_`Â prefix:

|Variable|Default|Description|
|---|---|---|
|`STWP_DEVICE`|auto-detect|Compute device (cpu/cuda/mps)|
|`STWP_DATA_PATH`|`data/input.grib`|Input data path|
|`STWP_MODEL_PATH`|`data/gnn_fh5.pt`|Model checkpoint path|
|`STWP_TRAIN_RATIO`|`0.333`|Train/test split|
|`STWP_BATCH_SIZE`|`8`|Training batch size|
|`STWP_FORECAST_HORIZON`|`1`|Prediction timesteps|
|`STWP_API_PORT`|`8888`|API server port|

SeeÂ [.env.example](../../.env.example)Â for complete list.

### CDS API Credentials

- **Removed**: Credentials from version control (`api/.cdsapirc`Â deleted)
- **Added**: Template fileÂ `api/.cdsapirc.example`Â with instructions

---

## âš ï¸ Breaking Changes

1. **Import paths**: All imports must change fromÂ `from models.gnn import ...`Â toÂ `from stwp.models.gnn import ...`
2. **Python version**: Requires Python 3.11+ (was 3.10)
3. **Package manager**:Â `uv`Â is now the expected tool (pip still works but lockfile is for uv)
4. **Feature strings**: Code usingÂ `'t2m'`Â literals should migrate toÂ `Features.T2M`
5. **Docker build**: New Dockerfile expects different structure; oldÂ `api/requirements`Â removed

---

## ğŸ—‘ï¸ Removed

- **Deleted directories**:Â `models/`,Â `utils/`,Â `api/model/`Â (moved to src/stwp/)
- **Deleted files**:Â `requirements.txt`,Â `api/requirements`,Â `api/script.sh`,Â `__init__.py`Â (root)
- **Old visualization**:Â `hpo/visualisation.py`Â (replaced byÂ `visualization.py`)
- **Credentials**:Â `api/.cdsapirc`Â (security improvement)

---

## ğŸ” Review Focus Areas

1. **Import path migration**: Verify all consumers of the old API have been updated
2. **Type annotations**: Check mypy passes with current configuration
3. **Test coverage**: Ensure critical paths are covered (especially GNN trainer, data processor)
4. **Docker security**: Verify non-root user doesn't break functionality
5. **Environment variables**: Ensure all configurable values work correctly

---

## Migration Guide

```bash
# 1. Install with new tooling
make install-dev

# 2. Update imports in any external code
# OLD: from models.gnn.trainer import Trainer
# NEW: from stwp.models.gnn.trainer import Trainer

# 3. Set up CDS credentials
cp api/.cdsapirc.example api/.cdsapirc
# Edit with your credentials

# 4. Verify everything works
make check  # lint + typecheck
make test   # run tests
```